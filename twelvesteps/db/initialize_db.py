import asyncio
import sys
import os

# Исправленные импорты: указываем папку db
from db.database import engine, async_session_factory, Base
from db.models import Step, Question

# Данные для вставки
DATA = [
  {
    "step": {
      "index": 1,
      "title": "Признание бессилия",
      "description": "Мы признали своё бессилие перед зависимостью, признали, что наша жизнь стала неуправляемой.",
      "questions": [
        "Что для меня означает «болезнь зависимость»?",
        "Была ли моя болезнь активна в последнее время? Как именно?",
        "Что происходит, когда я одержим чем-либо?",
        "Следует ли мое мышление определенному шаблону? Опиши.",
        "Когда мне в голову приходит какая-либо мысль, начинаю ли я действовать, не думая?",
        "Что заставляет меня все время сопротивляться?",
        "Манипулирую ли я другими людьми, поддерживая свою зависимость? Как именно?",
        "Бывало ли так, что я пытался бросить употреблять и понимал, что не могу?",
        "Как моя зависимость заставляла меня причинять ущерб себе или другим?",
        "Как я могу понять, что пора двигаться дальше?",
        "Как я понимаю Первый шаг?",
        "Как мои прежние знания и опыт повлияли на мою работу по этому шагу?"
      ]
    }
  },
  {
    "step": {
      "index": 2,
      "title": "Вера в восстановление",
      "description": "Мы пришли к убеждению, что только Сила, более могущественная, чем мы сами, может вернуть нам здравомыслие.",
      "questions": [
        "Понимаю ли я, что в моей жизни существуют проблемы, которые я уже не в силах решить?",
        "Что представляется мне наиболее трудным в процессе выздоровления?",
        "Какое отношение имеет принятие к моему выздоровлению?",
        "Трудно ли мне поверить в то, что нечто могло бы помочь мне?",
        "Что такое здравомыслие?",
        "Приходит ли здравомыслие незаметно? На что это похоже?",
        "Считаю ли я верой то, что некое Высшее Сила может помочь мне?",
        "Если я осознал, что Высшая Сила существует, было ли это похоже на понимание?",
        "Как этот шаг касается моего выздоровления и любви к самому себе?",
        "Как звучит Второй шаг на моем языке?",
        "Как я понимаю Второй шаг?",
        "Как мои прежние знания и опыт повлияли на мое понимание Второго шага?"
      ]
    }
  },
  {
    "step": {
      "index": 3,
      "title": "Решение доверить свою волю",
      "description": "Мы приняли решение препоручить нашу волю и нашу жизнь заботе Бога, как мы Его понимаем.",
      "questions": [
        "О чем я забочусь больше всего?",
        "Когда я был активным наркоманом, как страхи управляли моей жизнью?",
        "Как я поступал во время употребления с людьми, которые могли бы мне помочь?",
        "Был ли я готов просить о помощи?",
        "Почему мне было трудно принять чью-то помощь?",
        "Помогло ли отсутствие доверия восстановить контроль над моей жизнью?",
        "Если нет, как влияло это недоверие?",
        "Влияет ли мое недоверие на мою жизнь сегодня?",
        "Могу ли я снова оказаться в положении человека, утратившего контроль?",
        "Знаю ли я примеры того, когда мне удавалось избежать проблем, перестав полагаться на собственную волю?",
        "Как выглядит моя собственная воля сегодня?",
        "Как я поступаю, когда борюсь с Высшей Силой?",
        "Что для меня означает «передать свою волю Высшей Силе»?",
        "Пробовал ли я когда-либо передавать свою волю Высшей Силе? Опиши опыт.",
        "Что я могу сделать в этот раз, чтобы попробовать передать свою волю?",
        "Каким образом Высшая Сила может руководить моей жизнью?",
        "Как я понимаю Третий шаг?",
        "Как мои прежние знания и опыт повлияли на работу по этому шагу?"
      ]
    }
  },
  {
    "step": {
      "index": 4,
      "title": "Бесстрашная нравственная инвентаризация",
      "description": "Мы глубоко и бесстрашно исследовали себя с нравственной точки зрения.",
      "questions": [
        "В чем для меня цель Четвертого шага?",
        "Почему я боюсь писать Четвертый шаг?",
        "Как я могу подготовиться к этому шагу?",
        "Какое значение имеет честность в выполнении Четвертого шага?",
        "Какие шаблоны поведения приносят мне боль?",
        "Какие страхи мешают мне расти?",
        "Какие чувства я чаще всего подавляю?",
        "Какие отношения в моей жизни являются наиболее болезненными?",
        "Какие поступки я совершаю снова и снова, несмотря на ущерб от них?",
        "Какие ценности я нарушал?",
        "Какие обиды я все еще ношу в себе?"
      ]
    }
  },
  {
    "step": {
      "index": 5,
      "title": "Признание ошибок",
      "description": "Мы признали перед Богом, собой и каким-либо другим человеком истинную природу наших заблуждений.",
      "questions": [
        "Кому я могу довериться, выполняя Пятый шаг?",
        "Что мешает мне быть полностью честным?",
        "Какие части Четвёртого шага труднее всего озвучить?",
        "Какие чувства я испытываю перед тем, как поделиться всем?",
        "Что я ожидаю почувствовать после выполнения Пятого шага?",
        "Как признание своих ошибок вслух может помочь мне?",
        "Почему важно делиться своим прошлым?"
      ]
    }
  },
  {
    "step": {
      "index": 6,
      "title": "Готовность к избавлению от дефектов",
      "description": "Мы полностью подготовились к тому, чтобы Бог избавил нас от всех этих дефектов характера.",
      "questions": [
        "Готов ли я отпустить свои дефекты?",
        "Какие дефекты причиняют мне наибольший ущерб?",
        "Какие положительные качества могут занять место моих дефектов?",
        "Почему мне выгодно было держаться за старые привычки?",
        "Что мешает мне быть готовым к изменениям?",
        "Замечаю ли я, как мои дефекты проявляются в повседневной жизни?"
      ]
    }
  },
  {
    "step": {
      "index": 7,
      "title": "Смирение",
      "description": "Мы смиренно просили Его избавить нас от наших недостатков.",
      "questions": [
        "Что для меня означает смирение?",
        "Что мешает мне быть смиренным?",
        "Как проявляется моя гордыня?",
        "Прошу ли я Высшую Силу о помощи, когда мне трудно?",
        "Какие действия помогут мне стать смиреннее?",
        "Как я могу увидеть свой прогресс в этом шаге?"
      ]
    }
  },
  {
    "step": {
      "index": 8,
      "title": "Список людей, которым причинён вред",
      "description": "Мы составили список всех людей, кому мы причинили зло, и преисполнились желанием возместить им всем ущерб.",
      "questions": [
        "Кто пострадал от моих действий?",
        "Какие поступки причинили наибольший ущерб?",
        "Почему мне стыдно вспоминать о некоторых людях?",
        "Какие характерные дефекты лежали в основе моих поступков?",
        "Готов ли я признать свою ответственность?",
        "Есть ли люди, к которым мне особенно трудно включить в список?"
      ]
    }
  },
  {
    "step": {
      "index": 9,
      "title": "Возмещение ущерба",
      "description": "Мы напрямую возмещали причинённый этим людям ущерб, где только возможно, кроме тех случаев, когда это могло навредить им или другим людям.",
      "questions": [
        "Почему важно возмещать ущерб?",
        "Кому я нанес ущерб больше всего?",
        "Какой ущерб я могу возместить прямо сейчас?",
        "Какой ущерб я не могу возместить напрямую?",
        "Как мне определить, не нанесёт ли возмещение нового вреда?",
        "Какие чувства возникают у меня при мысли о встрече с людьми из прошлого?"
      ]
    }
  },
  {
    "step": {
      "index": 10,
      "title": "Ежедневный самоанализ",
      "description": "Мы продолжали самоанализ, и когда допускали ошибки, сразу признавали это.",
      "questions": [
        "Как я отслеживаю своё эмоциональное состояние?",
        "Есть ли у меня вредные привычки, которые пытаются вернуться?",
        "С кем я могу обсудить свой ежедневный прогресс?",
        "Когда я ошибаюсь, насколько быстро я это признаю?",
        "Какие чувства чаще всего вытесняю?",
        "Какие ситуации чаще всего выводят меня из равновесия?"
      ]
    }
  },
  {
    "step": {
      "index": 11,
      "title": "Молитва и медитация",
      "description": "Путём молитвы и медитации мы стремились улучшить свой сознательный контакт с Богом, как мы Его понимаем.",
      "questions": [
        "Что для меня значит молитва?",
        "Что для меня значит медитация?",
        "Могу ли я выделять время ежедневно для духовной практики?",
        "Какие методы духовного развития работают для меня?",
        "Какие результаты я хочу получить, выполняя этот шаг?",
        "Как я замечаю присутствие Высшей Силы в своей жизни?"
      ]
    }
  },
  {
    "step": {
      "index": 12,
      "title": "Духовное пробуждение и служение",
      "description": "Достигнув духовного пробуждения в результате выполнения этих шагов, мы стремились нести эту весть другим зависимым и применять эти принципы во всех наших делах.",
      "questions": [
        "Что изменилось в моей жизни благодаря шагам?",
        "Какой опыт выздоровления я могу передавать другим?",
        "Готов ли я помогать без ожидания выгоды?",
        "Каким образом я могу служить другим?",
        "Как я поддерживаю духовный рост каждый день?",
        "Какие принципы программы стали частью моей жизни?"
      ]
    }
  }
]

async def initialize_db_and_seed():
    # Создание таблиц (если они еще не созданы)
    async with engine.begin() as conn:
        await conn.run_sync(Base.metadata.create_all)
        print("Таблицы проверены/созданы.")

    # Вставка данных
    async with async_session_factory() as session:
        async with session.begin():
            # Сначала проверяем, пуста ли таблица Step, чтобы не дублировать данные
            # (опционально, но полезно)
            from sqlalchemy import select
            result = await session.execute(select(Step))
            if result.scalars().first():
                print("База данных уже содержит шаги. Пропускаем инициализацию.")
                return

            for item in DATA:
                step_data = item["step"]
                
                # Создаем объект Step с названием и описанием
                new_step = Step(
                    index=step_data["index"],
                    title=step_data.get("title"),
                    description=step_data.get("description")
                )
                session.add(new_step)
                
                # Flush нужен, чтобы база данных присвоила ID новому шагу до добавления вопросов
                await session.flush() 

                # Добавляем вопросы, привязанные к этому шагу
                for q_text in step_data["questions"]:
                    new_question = Question(
                        text=q_text, 
                        step_id=new_step.id 
                    )
                    session.add(new_question)
            
        print("Вопросы успешно добавлены в базу данных.")

if __name__ == "__main__":
    # Убедимся, что путь корректен при запуске
    current_path = os.getcwd()
    sys.path.append(current_path)
    
    asyncio.run(initialize_db_and_seed())