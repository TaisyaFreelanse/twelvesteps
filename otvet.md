–û–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ —Å–∏—Å—Ç–µ–º–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏
–ß—Ç–æ —É–∂–µ –µ—Å—Ç—å (—Ö–æ—Ä–æ—à–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
–ë–∞–∑–æ–≤–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:
–≠–º–æ—Ü–∏–∏, –±–ª–æ–∫–∏, thinking_frame, level_of_mind, memory_type
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—Ä–µ–π–º–æ–≤ –≤ –ë–î
–ö–æ–º–∞–Ω–¥—ã /qa_last, /qa_ctx, /qa_trace –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
–ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è:
–°–±–æ—Ä–∫–∞ –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ –≤—Å–µ—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (onboarding, profile, steps, chat)
Helper prompts –∏–∑ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–µ–π–º–æ–≤
–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö:
–ú–æ–¥–µ–ª–∏ Frame, Message, SessionState
–í–µ–∫—Ç–æ—Ä–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ñ—Ä–µ–π–º–æ–≤
–ß—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
1. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î (–∫—Ä–∏—Ç–∏—á–Ω–æ)
–ü—Ä–æ–±–ª–µ–º–∞: –ª–æ–≥–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ (USER_LOGS), —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ.
–†–µ—à–µ–Ω–∏–µ:
# –ù–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ interaction_logsclass InteractionLog(Base):    __tablename__ = "interaction_logs"        id: Mapped[int]    user_id: Mapped[int]    interaction_type: Mapped[str]  # 'chat', 'step', 'profile', 'sos'        # –í—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ    user_message: Mapped[str]    question_text: Mapped[Optional[str]]        # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è    emotions: Mapped[List[str]]  # JSON    blocks: Mapped[List[str]]  # JSON    frames_detected: Mapped[List[dict]]  # JSON    thinking_frame: Mapped[Optional[str]]        # –ü—Ä–æ–º–ø—Ç—ã    personalized_prompt_snapshot: Mapped[str]  # –¢–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç –∑–∞–ø—Ä–æ—Å–∞    system_prompt_used: Mapped[str]    helper_prompt_used: Mapped[str]    session_context: Mapped[Optional[str]]        # LLM –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ    llm_model: Mapped[str]  # 'gpt-4o', 'gpt-4o-mini', etc.    tokens_used: Mapped[Optional[int]]    response_time_ms: Mapped[Optional[int]]        # –û—Ç–≤–µ—Ç    gpt_response: Mapped[str]    emotional_part: Mapped[Optional[str]]  # –ï—Å–ª–∏ –¥–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π    structural_part: Mapped[Optional[str]]        created_at: Mapped[datetime]
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è:
–û—Ç–ª–∞–¥–∫–∏ –ø—Ä–æ–±–ª–µ–º –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ
–ê–Ω–∞–ª–∏–∑–∞ –∫–∞—á–µ—Å—Ç–≤–∞ –æ—Ç–≤–µ—Ç–æ–≤
–ü–æ–Ω–∏–º–∞–Ω–∏—è, –ø–æ—á–µ–º—É GPT –¥–∞–ª –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç
–ê—É–¥–∏—Ç–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
2. –ö–æ–º–∞–Ω–¥–∞ /debug_last (–≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
async def handle_debug_last(message: Message) -> None:    """Show detailed log of last interaction"""    user_id = message.from_user.id        # Get last log from DB    log = await get_last_interaction_log(user_id)        if not log:        await message.answer("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏")        return        debug_text = f"""üîç –î–ï–¢–ê–õ–¨–ù–´–ô –õ–û–ì –ü–û–°–õ–ï–î–ù–ï–ì–û –í–ó–ê–ò–ú–û–î–ï–ô–°–¢–í–ò–Ø‚ùì –í–æ–ø—Ä–æ—Å: {log.question_text or '–û–±—ã—á–Ω—ã–π —á–∞—Ç'}‚úçÔ∏è –°–æ–æ–±—â–µ–Ω–∏–µ: {log.user_message[:200]}...üß† –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è:‚Ä¢ –≠–º–æ—Ü–∏–∏: {', '.join(log.emotions)}‚Ä¢ –ë–ª–æ–∫–∏: {', '.join(log.blocks)}‚Ä¢ –§—Ä–µ–π–º –º—ã—à–ª–µ–Ω–∏—è: {log.thinking_frame}üßæ –ü—Ä–æ–º–ø—Ç—ã:‚Ä¢ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π: {len(log.personalized_prompt_snapshot)} —Å–∏–º–≤–æ–ª–æ–≤‚Ä¢ –°–∏—Å—Ç–µ–º–Ω—ã–π: {log.system_prompt_used[:100]}...‚Ä¢ Helper: {len(log.helper_prompt_used)} —Å–∏–º–≤–æ–ª–æ–≤ü§ñ LLM:‚Ä¢ –ú–æ–¥–µ–ª—å: {log.llm_model}‚Ä¢ –¢–æ–∫–µ–Ω—ã: {log.tokens_used}‚Ä¢ –í—Ä–µ–º—è: {log.response_time_ms}msüí¨ –û—Ç–≤–µ—Ç GPT:{log.gpt_response[:500]}..."""    await send_long_message(message, debug_text)
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –æ—Ç–ª–∞–¥–∫–∏ –±–µ–∑ –¥–æ—Å—Ç—É–ø–∞ –∫ –ë–î.
–ß—Ç–æ –≤–∞–∂–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ—ç—Ç–∞–ø–Ω–æ
3. –î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –æ—Ç–≤–µ—Ç (emotional + structural)
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: GPT –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–∏–Ω —Ç–µ–∫—Å—Ç.
–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:
# –í Bot.chat() –∏–∑–º–µ–Ω–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞response_format = {    "emotional": "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –æ—Ç–∫–ª–∏–∫...",    "structural": "–°—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π –∞–Ω–∞–ª–∏–∑..."}
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: –≤–∞–∂–Ω–æ –¥–ª—è UX, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ two_level_response=True –∏ –≤–∫–ª—é—á–∞—Ç—å –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏.
4. –£–≥–ª—É–±–ª–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏–π
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –µ—Å—Ç—å thinking_frame, –Ω–æ –Ω–µ—Ç —è–≤–Ω—ã—Ö –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤.
–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ: —Ä–∞—Å—à–∏—Ä–∏—Ç—å classify.json:
{  "defense_mechanisms": [    "–∫–æ–Ω—Ç—Ä–æ–ª—å", "–∏–∑–±–µ–≥–∞–Ω–∏–µ", "—Ä–∞—Ü–∏–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è",     "—Å—Ç—ã–¥", "–æ—Ç–≤–µ—Ä–∂–µ–Ω–∏–µ", "—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏–µ"  ],  "frame_types": [    "–≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ–Ω—Ñ–ª–∏–∫—Ç", "–ø–µ—Ç–ª—è",     "–∑–∞—â–∏—Ç–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è", "–¥–µ—Ç—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è"  ]}
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: —É–ª—É—á—à–∏—Ç –∫–∞—á–µ—Å—Ç–≤–æ, –Ω–æ –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –æ—Ç–ª–∞–¥–∫—É. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤ —Å–ª–µ–¥—É—é—â–µ–π –∏—Ç–µ—Ä–∞—Ü–∏–∏.
–ß—Ç–æ –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å (–Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
5. Engine –ø–∞–º—è—Ç–∏ (Volatile/Dynamic/Stable)
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –µ—Å—Ç—å memory_type –≤ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏, –Ω–æ –Ω–µ—Ç —è–≤–Ω–æ–≥–æ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —É—Ä–æ–≤–Ω–µ–π.
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω–æ –≤–µ—Ä–Ω–æ, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥–∞. –ú–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–æ—Å–ª–µ –±–∞–∑–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è.
6. –Ø–¥—Ä–æ –ª–∏—á–Ω–æ—Å—Ç–∏
–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ: –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: –ø–æ–ª–µ–∑–Ω–æ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ.
7. –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
–ù–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç—å: —É–¥–æ–±–Ω–æ, –Ω–æ –Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ. –°–Ω–∞—á–∞–ª–∞ ‚Äî –∫–æ–º–∞–Ω–¥–∞ /debug_last, –∑–∞—Ç–µ–º –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏
–§–∞–∑–∞ 1 (—Å–µ–π—á–∞—Å):
–¢–∞–±–ª–∏—Ü–∞ interaction_logs –≤ –ë–î
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—Å–µ—Ö –ª–æ–≥–æ–≤ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏
–ö–æ–º–∞–Ω–¥–∞ /debug_last –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
–§–∞–∑–∞ 2 (–ø–æ—Å–ª–µ –±–∞–∑–æ–≤–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è):
–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –æ—Ç–≤–µ—Ç (–µ—Å–ª–∏ –Ω—É–∂–µ–Ω)
–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
–§–∞–∑–∞ 3 (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è):
Engine –ø–∞–º—è—Ç–∏ (Volatile/Dynamic/Stable)
–Ø–¥—Ä–æ –ª–∏—á–Ω–æ—Å—Ç–∏ —Å —Ä—É—á–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º
–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
–û—Ç–≤–µ—Ç –∫–ª–∏–µ–Ω—Ç—É (–∫—Ä–∞—Ç–∫–∞—è –≤–µ—Ä—Å–∏—è)
"–°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –æ—Ç–ª–∞–¥–∫–∏ ‚Äî –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ —Ä–∞–∑–≤–∏—Ç–∏—è GPT-SELF.
–ß—Ç–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç:
–ë–∞–∑–æ–≤–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è —ç–º–æ—Ü–∏–π –∏ —Ñ—Ä–µ–π–º–æ–≤
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ñ—Ä–µ–π–º–æ–≤ –≤ –ë–î
–ö–æ–º–∞–Ω–¥—ã –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ –≤ –ø–∞–º—è—Ç–∏
–ß—Ç–æ –∫—Ä–∏—Ç–∏—á–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å:
–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ª–æ–≥–æ–≤ –≤ –ë–î (—Å–µ–π—á–∞—Å —Ç–µ—Ä—è—é—Ç—Å—è –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ)
–ö–æ–º–∞–Ω–¥–∞ /debug_last –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
–ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ LLM (–º–æ–¥–µ–ª—å, —Ç–æ–∫–µ–Ω—ã, –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞)
–ß—Ç–æ –≤–∞–∂–Ω–æ, –Ω–æ –º–æ–∂–Ω–æ –ø–æ—ç—Ç–∞–ø–Ω–æ:
–î–≤—É—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–π –æ—Ç–≤–µ—Ç (emotional + structural)
–†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –∑–∞—â–∏—Ç–Ω—ã—Ö –º–µ—Ö–∞–Ω–∏–∑–º–æ–≤
Engine –ø–∞–º—è—Ç–∏ –∏ —è–¥—Ä–æ –ª–∏—á–Ω–æ—Å—Ç–∏
–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: –Ω–∞—á–∞—Ç—å —Å –§–∞–∑—ã 1 (–ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ –ë–î + /debug_last), —ç—Ç–æ –¥–∞—Å—Ç 80% –ø–æ–ª—å–∑—ã –ø—Ä–∏ 20% —É—Å–∏–ª–∏–π. –û—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ –º–µ—Ä–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏."