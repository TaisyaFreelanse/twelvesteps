# Чеклист тестирования проекта 12 шагов

## 10.1 Тестирование

### ✅ Проверка работы всех новых эндпоинтов

#### SessionState эндпоинты
- [ ] `GET /user/state` - получение оперативного состояния
  - [ ] Проверка аутентификации (должен требовать токен)
  - [ ] Проверка возврата данных для существующего пользователя
  - [ ] Проверка 404 для пользователя без SessionState
  - [ ] Проверка структуры ответа (recent_messages, daily_snapshot, active_blocks, pending_topics, group_signals)

- [ ] `POST /user/state` - обновление состояния
  - [ ] Создание нового SessionState
  - [ ] Обновление существующего SessionState
  - [ ] Частичное обновление (только некоторые поля)
  - [ ] Проверка сохранения данных

#### FrameTracking эндпоинты
- [ ] `GET /user/frames` - получение фреймов и трекинга
  - [ ] Проверка возврата данных для существующего пользователя
  - [ ] Проверка структуры ответа (confirmed, candidates, tracking, archetypes, meta_flags)

- [ ] `POST /user/frames` - обновление фреймов
  - [ ] Создание нового FrameTracking
  - [ ] Обновление существующего FrameTracking
  - [ ] Проверка сохранения данных

#### QAStatus эндпоинты
- [ ] `GET /user/qa-status` - получение статуса QA
  - [ ] Проверка возврата данных для существующего пользователя
  - [ ] Проверка структуры ответа (last_prompt_included, trace_ok, open_threads, rebuild_required)

- [ ] `POST /user/qa-status` - обновление статуса QA
  - [ ] Создание нового QAStatus
  - [ ] Обновление существующего QAStatus
  - [ ] Проверка сохранения данных

#### TrackerSummary эндпоинты
- [ ] `GET /user/tracker-summary` - получение сводки трекера
  - [ ] Получение по дате (параметр `date`)
  - [ ] Получение последней сводки (без параметра `date`)
  - [ ] Проверка структуры ответа (thinking, feeling, behavior, relationships, health, date)

- [ ] `POST /user/tracker-summary` - сохранение сводки
  - [ ] Создание новой сводки
  - [ ] Обновление существующей сводки (уникальный индекс на user_id + date)
  - [ ] Проверка автоматического использования текущей даты, если не указана

#### UserMeta эндпоинты
- [ ] `GET /user/meta` - получение метаданных пользователя
  - [ ] Проверка возврата данных для существующего пользователя
  - [ ] Проверка структуры ответа (metasloy_signals, prompt_revision_history, time_zone, language, data_flags)

- [ ] `PUT /user/meta` - обновление метаданных
  - [ ] Создание нового UserMeta (один к одному с User)
  - [ ] Обновление существующего UserMeta
  - [ ] Проверка уникальности (один UserMeta на пользователя)

#### Другие эндпоинты
- [ ] `POST /thanks` - команда благодарности
  - [ ] Проверка отличия от `/day`
  - [ ] Проверка вариативности ответов при повторных вызовах
  - [ ] Проверка сохранения last_command в SessionContext

- [ ] `POST /day` - команда анализа дня
  - [ ] Проверка аналитического характера ответа
  - [ ] Проверка отличия от `/thanks`
  - [ ] Проверка сохранения last_command в SessionContext

---

### ✅ Тестирование FSM состояний в боте

- [ ] Регистрация нового пользователя
  - [ ] Команда `/start` запускает процесс регистрации
  - [ ] Переход в состояние `self_description`
  - [ ] Ввод валидного описания завершает регистрацию
  - [ ] Ввод вопроса возвращает сообщение и остается в состоянии `self_description`
  - [ ] Проверка функции `is_question()` для различных типов вопросов

- [ ] Основные команды
  - [ ] `/thanks` - отправка сообщения поддержки
  - [ ] `/day` - отправка аналитического сообщения
  - [ ] `/sos` - генерация примера ответа
  - [ ] Проверка возврата в главное меню после команд

- [ ] Обработка ошибок
  - [ ] Ошибка при обращении к API возвращает сообщение с кнопкой перезапуска
  - [ ] Кнопка "Начать заново" возвращает к `/start`

---

### ✅ Проверка миграций базы данных

- [ ] Применение всех миграций
  - [ ] `d1e2f3a4b5c6_add_user_extended_fields.py` - расширенные поля User
  - [ ] `e2f3a4b5c6d7_add_session_state.py` - таблица session_states
  - [ ] `f3a4b5c6d7e8_add_frame_tracking.py` - таблица frame_tracking
  - [ ] `g4a5b6c7d8e9_add_qa_status.py` - таблица qa_status
  - [ ] `h5a6b7c8d9e0_add_user_meta.py` - таблица user_meta
  - [ ] `i6a7b8c9d0e1_add_tracker_summary.py` - таблица tracker_summaries

- [ ] Откат миграций (downgrade)
  - [ ] Проверка корректного удаления таблиц при откате
  - [ ] Проверка сохранности данных при откате/накате

- [ ] Проверка структуры таблиц
  - [ ] Все поля созданы корректно
  - [ ] Индексы созданы
  - [ ] ForeignKey связи работают
  - [ ] Unique constraints работают (user_meta.user_id, tracker_summaries(user_id, date))

---

### ✅ Тестирование исправлений багов из отчета

#### Bug #005: Команда /thanks генерирует похожие ответы на /day
- [ ] Команда `/thanks` возвращает сообщения поддержки и мотивации
- [ ] Команда `/day` возвращает аналитические сообщения с вопросами
- [ ] Ответы различаются по содержанию и стилю
- [ ] При повторных вызовах `/thanks` используются вариации ответов
- [ ] Проверка использования разных промптов (thanks.json vs day.json)

#### Bug #006: Отсутствие валидации ввода на этапе регистрации
- [ ] Ввод вопроса на этапе регистрации обнаруживается
- [ ] Пользователю показывается сообщение с просьбой рассказать о себе
- [ ] Пользователь остается в состоянии `self_description`
- [ ] Валидный ввод завершает регистрацию
- [ ] Проверка функции `is_question()` для различных форматов вопросов

---

### ✅ Проверка работы расширенной структуры данных GPT_SELF_UJSON_v3

- [ ] Модели данных
  - [ ] User: relapse_dates, sponsor_ids, custom_fields, last_active
  - [ ] SessionState: recent_messages, daily_snapshot, active_blocks, pending_topics, group_signals
  - [ ] FrameTracking: confirmed, candidates, tracking, archetypes, meta_flags
  - [ ] QAStatus: last_prompt_included, trace_ok, open_threads, rebuild_required
  - [ ] UserMeta: metasloy_signals, prompt_revision_history, time_zone, language, data_flags
  - [ ] TrackerSummary: thinking, feeling, behavior, relationships, health, date

- [ ] JSON поля
  - [ ] Корректное сохранение JSON данных
  - [ ] Корректное чтение JSON данных
  - [ ] Валидация структуры JSON

- [ ] Связи между моделями
  - [ ] ForeignKey связи работают
  - [ ] CASCADE удаление работает
  - [ ] One-to-one связь User-UserMeta работает

---

### ✅ Тестирование интеграции контекста сессий

- [ ] SessionState интеграция
  - [ ] Создание SessionState при первом взаимодействии
  - [ ] Сохранение recent_messages при каждом сообщении
  - [ ] Обновление daily_snapshot на основе классификации
  - [ ] Обновление active_blocks из классификации
  - [ ] Добавление pending_topics и group_signals

- [ ] SessionContext интеграция
  - [ ] Сохранение last_command при использовании `/thanks` и `/day`
  - [ ] Проверка вариативности ответов на основе last_command
  - [ ] Разные типы сессий (CHAT, STEPS, DAY)

- [ ] Использование контекста в промптах
  - [ ] SessionState используется в контексте LLM
  - [ ] FrameTracking учитывается при генерации ответов
  - [ ] TrackerSummary используется для персонализации

---

### ✅ Проверка валидации ввода на этапе регистрации

- [ ] Функция `is_question()` в `twelvesteps_tgbot/bot/utils.py`
  - [ ] Обнаружение вопросов с вопросительным знаком
  - [ ] Обнаружение вопросов с вопросительными словами (что, как, где, когда, кто, почему, зачем)
  - [ ] Обнаружение вопросов с фразами (расскажи о себе, что ты умеешь)
  - [ ] Игнорирование обычных утверждений

- [ ] Обработка в `handle_self_description`
  - [ ] Вопрос обнаруживается и обрабатывается
  - [ ] Показывается сообщение с просьбой рассказать о себе
  - [ ] Пользователь остается в состоянии `self_description`
  - [ ] Валидный ввод завершает регистрацию

- [ ] Граничные случаи
  - [ ] Пустой ввод
  - [ ] Очень длинный ввод
  - [ ] Ввод с эмодзи
  - [ ] Ввод с специальными символами

---

## Инструкции по тестированию

### Подготовка к тестированию

1. **Запуск базы данных:**
   ```bash
   docker-compose up -d
   ```

2. **Применение миграций:**
   ```bash
   cd twelvesteps
   alembic upgrade head
   ```

3. **Запуск API сервера:**
   ```bash
   cd twelvesteps
   python -m uvicorn api.main:app --reload
   ```

4. **Запуск Telegram бота:**
   ```bash
   cd twelvesteps_tgbot
   python main.py
   ```

### Инструменты для тестирования

- **API тестирование:** Postman, curl, или httpie
- **База данных:** pgAdmin, DBeaver, или psql
- **Telegram бот:** Тестовый бот в Telegram

### Примеры тестовых запросов

#### Получение SessionState
```bash
curl -X GET "http://localhost:8000/user/state" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

#### Обновление SessionState
```bash
curl -X POST "http://localhost:8000/user/state" \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "recent_messages": [{"timestamp": "2025-01-27T12:00:00Z", "text": "Тест", "tags": []}],
    "active_blocks": ["block1", "block2"]
  }'
```

---

## Результаты тестирования

После выполнения всех проверок, отметьте результаты здесь:

- [ ] Все эндпоинты работают корректно
- [ ] FSM состояния работают корректно
- [ ] Миграции применены успешно
- [ ] Баги исправлены
- [ ] Расширенная структура данных работает
- [ ] Интеграция контекста сессий работает
- [ ] Валидация ввода работает корректно

**Дата тестирования:** _______________
**Тестировщик:** _______________
**Версия:** _______________

